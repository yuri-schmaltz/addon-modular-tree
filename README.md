# Mtree

Mtree (previously Modular Tree) is a library for making 3d trees. It comes as an addon for blender but the c++ library can be used separately.

## Table of contents
- [Mtree](#mtree)
  - [Table of contents](#table-of-contents)
  - [Installation (blender extension)](#installation-blender-extension)
    - [Compatibility](#compatibility)
    - [Quickstart (5 passos)](#quickstart-5-passos)
    - [Troubleshooting](#troubleshooting)
    - [Uninstall](#uninstall)
  - [Development](#development)
    - [Dependencies](#dependencies)
    - [Installation](#installation)
    - [Smoke test (Blender CLI)](#smoke-test-blender-cli)
    - [Usage](#usage)
  - [License](#license)


## Installation (blender extension)
Go to the [latest release]. Under `Assets`, select the version corresponding to your os.\
In Blender 4.2+: `Edit > Preferences > Extensions > Install from Disk...` and select the zip.\
See the [blender extensions doc][blender extensions doc] for details.

### Compatibility
- Prebuilt release assets target **Blender 4.2+** (Python 3.11).
- For other Blender/Python versions, rebuild the native `m_tree` module with the **same Python ABI used by Blender**.

### Quickstart (5 passos)
1. Baixe o zip correto para seu sistema em [latest release].
2. No Blender: `Edit > Preferences > Extensions > Install from Disk...` e selecione o zip.
3. Ative o add-on **Modular Tree** na lista.
4. Abra o **Node Editor** e troque o tipo de arvore para **Mtree**.
5. Adicione `Tree Mesher` e `Trunk`, conecte `Tree -> Tree` e clique em **Generate Tree**.

### Troubleshooting
- **"Modular Tree native module not found"**: compile o `m_tree` para a mesma versao do Python do Blender e copie o `.pyd/.so/.dylib` ao lado do `__init__.py`.
- **"Failed to load native module" / "DLL load failed" (Windows)**: confirme o ABI do Python e a presenca dos runtimes (MSVC ou MinGW conforme o compilador).
- **Blender < 4.2**: atualize para 4.2+ (o add-on exige essa versao minima).

#### Diagnostic Tool
Se encontrar problemas, use a nossa ferramenta de diagnóstico integrada:
1. No **Node Editor**, abra a **Sidebar (N)**.
2. Selecione a aba **Mtree**.
3. Clique em **Run Diagnostics**. O relatório será copiado para o clipboard e impresso no console do Blender.

### Uninstall
1. `Edit > Preferences > Extensions`, desative o **Modular Tree**.
2. Clique em **Remove** (se instalado por zip).
3. Opcional: apague `scripts/addons/modular_tree` na pasta de usuario do Blender.

## Development
### Dependencies
- [Cmake]
- Blender 4.2+ (if you want to develop the blender addon with the default setup)
- `vcpkg` e `pybind11` sao submodulos fixos no repositorio para builds reproduziveis.

### Installation
1. Clone the repository reccursively `git clone --recursive https://github.com/MaximeHerpin/modular_tree`
2. Execute the install script using the Python version that matches Blender:
   ```bash
   python core/m_tree/install.py
   ```
3. If all went well, a cmake project has been generated under `mtree/build`.
4. You can bundle the blender addon by calling the [addon bundling script].

Useful overrides for `m_tree/install.py`:
- `PYTHON_EXECUTABLE`: Python executable used for headers/libs lookup.
- `MTREE_PYTHON_VERSION`: Python minor version for pybind configuration.
- `PYBIND11_DIR`: force a specific pybind11 CMake directory (pin this if using system pybind11).
- `MTREE_USE_SYSTEM_PYBIND11=1`: opt-in to auto-detect pybind11 from the Python environment.
- `VCPKG_TRIPLET`: override vcpkg triplet (e.g. `x64-mingw-dynamic`).
- `CMAKE_GENERATOR`, `CMAKE_C_COMPILER`, `CMAKE_CXX_COMPILER`: explicit toolchain selection.

### Smoke test (Blender CLI)
```bash
blender -b --factory-startup --python scripts/smoke_blender_addon.py -- --addon-dir .
```
If this fails with a native module message, build/copy the `m_tree` binary for the Blender Python version first.

```bash
blender -b --factory-startup --python scripts/smoke_e2e_tree_build.py -- --addon-dir .
```

```bash
python .github/scripts/setup_addon.py
blender -b --factory-startup --python scripts/smoke_install_addon.py -- --zip-path tmp/modular_tree-<version>-<platform>.zip
```

### Usage
A `Tree` is generated by executing a succession of `TreeFunction`. When being executed, a `TreeFunction` modifies the structure of the tree, and then calls children functions recursively.\
For example, a basic tree has a trunk and branches on the trunk. Such a tree can be generated as such:
```c++
auto trunk = std::make_shared<TrunkFunction>();
auto branches = std::make_shared<BranchFunction>();
trunk->add_child(branches); // branches are added on top of the trunk
Tree tree(trunk);
tree.execute_functions(); // The tree structure is generated
ManifoldMesher mesher; // A mesher is responsible of converting a tree into a 3d mesh. The ManifoldMesher ensures a smooth topology
mesher.radial_resolution = 32;
Mesh tree_mesh = mesher.mesh_tree(tree); // the resulting mesh contains the geometry of the tree in the form of vertices and triangles
```
A second layer of branches can be grown on top of the branches by adding another branch function as a child of the first branch function: 
```c++
auto branches_primary = std::make_shared<BranchFunction>();
auto branches_secondary = std::make_shared<BranchFunction>();
branches_primary.add_child(branches_secondary); // the secondray branches will be distributed on top of the primary branches
```
Some trees have healthy branches as well as a layer of thin dead branches along the trunk. This can be achieved by adding to branch functions with different parameters on the trunk:
```c++
auto trunk = std::make_shared<TrunkFunction>();
auto branches_healthy = std::make_shared<BranchFunction>();
auto branches_dead = std::make_shared<BranchFunction>();
branches_dead.length = RandomProperty{.1f,1f}; // dead branches will have a length between 10cm and 1m.
branches_dead.start_radius = ConstantProperty{.05f}; // dead branches will have a radius equal to 5% of the parent nodes

trunk->add_child(branches_healthy); // both sets of branches are grown on top of the trunk
trunk->add_child(branches_dead);
Tree tree(trunk);
```
## License
Blender being under the GPL license, the blender addon (all files under `core` as well as `__init__.py`) is under the [GPLv3] license.\
The Mtree library is under the [MIT] license.


[latest release]: https://github.com/MaximeHerpin/modular_tree/releases
[blender extensions doc]: https://docs.blender.org/manual/en/latest/advanced/extensions/getting_started.html
[Cmake]: https://cmake.org/
[addon bundling script]: ./.github/scripts/setup_addon.py
[GPLv3]: https://www.gnu.org/licenses/gpl-3.0.en.html
[MIT]: https://choosealicense.com/licenses/mit/\
